# 分布式缓存设计

## 为什么需要分布式缓存

单机缓存（比如进程内的 Map）有两个问题：
1. 容量有限，受单机内存限制
2. 多个服务实例之间缓存不共享

分布式缓存（如 Redis 集群）解决了这两个问题：所有服务实例共享同一份缓存，且可以水平扩展。

## 一致性哈希

当缓存分布在多个节点上时，怎么决定一个 key 存在哪个节点？

简单取模：`node = hash(key) % N`。问题是增减节点时，几乎所有 key 都要重新分配。

一致性哈希：把节点和 key 都映射到一个环上，key 顺时针找到最近的节点。增减节点只影响相邻的一小部分 key。

## 缓存与数据库的一致性

这是分布式缓存最头疼的问题。

### 常见方案

| 方案 | 做法 | 问题 |
|------|------|------|
| 先更新数据库，再删缓存 | 最常用 | 极端情况下短暂不一致 |
| 先删缓存，再更新数据库 | 简单 | 并发时容易读到旧数据 |
| 延迟双删 | 删缓存→更新DB→延迟再删缓存 | 延迟时间不好定 |
| 订阅 binlog | 监听数据库变更，异步更新缓存 | 架构复杂但最可靠 |

推荐方案：先更新数据库，再删缓存。配合合理的过期时间作为兜底。

## 热点 Key 问题

某个 key 被大量请求访问（比如热搜），单个 Redis 节点扛不住。

解决方案：
- 本地缓存 + Redis 缓存两级架构
- 热点 key 复制到多个节点
- 随机后缀分散到多个 key

## Redis 集群模式

| 模式 | 特点 |
|------|------|
| 主从复制 | 读写分离，主节点写，从节点读 |
| 哨兵模式 | 自动故障转移，主节点挂了自动选新主 |
| Cluster | 数据分片，水平扩展，官方推荐 |

> 分布式缓存的核心挑战不是"快"，而是"一致"。
