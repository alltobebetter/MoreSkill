# 分布式系统基础

## 什么是分布式系统

分布式系统就是多台计算机协同工作，对外表现为一个整体。

比喻：一个人搬家很慢，叫 10 个朋友一起搬就快了。但你需要协调谁搬什么、怎么搬、搬到哪。

## CAP 定理

分布式系统不可能同时满足三个条件：

| | 含义 |
|---|------|
| C（一致性） | 所有节点看到的数据一样 |
| A（可用性） | 每个请求都能得到响应 |
| P（分区容错） | 网络分区时系统仍能运行 |

网络分区是不可避免的，所以实际上是在 C 和 A 之间选择：
- CP：保证一致性，牺牲可用性（如 ZooKeeper）
- AP：保证可用性，牺牲一致性（如 Cassandra）

## 常见问题与解决方案

### 分布式 ID

多个服务同时生成 ID，怎么保证不重复？

| 方案 | 特点 |
|------|------|
| UUID | 简单，但无序，索引性能差 |
| 雪花算法 | 有序，高性能，需要时钟同步 |
| 数据库自增 | 简单，但有单点瓶颈 |
| Redis INCR | 高性能，需要 Redis 可用 |

### 分布式锁

多个服务实例同时操作同一资源，怎么保证互斥？

```javascript
// Redis 分布式锁
const locked = await redis.set('lock:order:123', 'owner1', 'NX', 'EX', 30)
if (locked) {
  try {
    // 执行业务逻辑
  } finally {
    await redis.del('lock:order:123')
  }
}
```

### 分布式事务

跨服务的事务怎么保证一致性？

| 方案 | 复杂度 | 一致性 |
|------|--------|--------|
| 2PC（两阶段提交） | 高 | 强一致 |
| TCC（Try-Confirm-Cancel） | 高 | 强一致 |
| Saga | 中 | 最终一致 |
| 本地消息表 | 低 | 最终一致 |

大部分场景用"最终一致性"就够了。

## 服务发现

微服务之间怎么找到对方？

- 客户端发现：服务自己去注册中心查（Eureka）
- 服务端发现：通过负载均衡器路由（Kubernetes Service）

> 分布式系统的核心挑战不是"分布"，而是"一致"和"容错"。
